<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æ–‡å¬å†™ç»ƒä¹  (é©¬åŠ›å¹³ç¬¬ä¸€å•å…ƒ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ï¼Œè®©ç”»æ¿çœ‹èµ·æ¥æ›´æ¸…æ™° */
        canvas {
            touch-action: none; /* é˜²æ­¢åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šç»˜å›¾æ—¶é¡µé¢æ»šåŠ¨ */
            border: 2px solid #e2e8f0; /* è¾¹æ¡† */
            border-radius: 0.5rem; /* åœ†è§’ */
        }
        /* æ¿€æ´»æ ‡ç­¾çš„æ ·å¼ */
        .tab-active {
            border-bottom-color: #3b82f6; /* è“è‰²ä¸‹åˆ’çº¿ */
            color: #3b82f6; /* è“è‰²æ–‡å­— */
            font-weight: 600; /* ç²—ä½“ */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 max-w-lg w-full">
        <div class="bg-white rounded-xl shadow-2xl p-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">ä¸­æ–‡å¬å†™ç»ƒä¹ </h1>
            <p class="text-center text-gray-500 mb-6">é©¬åŠ›å¹³æ•™æ - ç¬¬ä¸€å•å…ƒ</p>

            <div id="start-screen" class="text-center py-10">
                <h2 class="text-2xl font-semibold mb-6">å‡†å¤‡å¥½äº†å—ï¼Ÿ</h2>
                <p class="text-gray-600 mb-8">ç‚¹å‡»â€œå¼€å§‹â€æ¥å”¤é†’è¯­éŸ³åŠŸèƒ½ã€‚</p>
                <button id="start-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-xl transition-transform transform hover:scale-105 focus:outline-none">
                    å¼€å§‹ç»ƒä¹ 
                </button>
            </div>

            <div id="practice-container" class="hidden">
                <div class="flex border-b-2 border-gray-200 mb-4">
                    <button id="tab-chars" class="flex-1 py-2 text-center text-gray-500 hover:text-gray-700 focus:outline-none tab-active">
                        ç”Ÿå­—ç»ƒä¹ 
                    </button>
                    <button id="tab-strokes" class="flex-1 py-2 text-center text-gray-500 hover:text-gray-700 focus:outline-none">
                        ç¬”ç”»ç»ƒä¹ 
                    </button>
                </div>

                <div id="dictation-area">
                    <div class="flex justify-between items-center mb-4">
                        <span id="progress" class="text-lg text-gray-600"></span>
                        <button id="play-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </button>
                    </div>

                    <div id="answer-display" class="text-center mb-4 p-4 bg-yellow-100 text-yellow-800 rounded-lg hidden">
                        <span class="font-bold">ç­”æ¡ˆï¼š</span>
                        <span id="answer-text" class="text-5xl font-bold" style="font-family: 'KaiTi', 'STKaiti', 'serif';"></span>
                    </div>

                    <div id="complete-display" class="text-center mb-4 p-4 bg-green-100 text-green-800 rounded-lg hidden">
                        <h2 class="text-2xl font-bold mb-2">ğŸ‰ æ­å–œä½ ï¼</h2>
                        <p class="text-lg">ä½ å·²ç»å®Œæˆäº†æœ¬ç»„çš„å…¨éƒ¨ç»ƒä¹ ï¼</p>
                        <button id="restart-btn" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            é‡æ–°å¼€å§‹
                        </button>
                    </div>

                    <canvas id="draw-canvas"></canvas>

                    <div class="grid grid-cols-3 gap-4 mt-4">
                        <button id="clear-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg shadow transition-transform transform hover:scale-105 focus:outline-none">
                            æ¸…é™¤
                        </button>
                        <button id="show-answer-btn" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg shadow transition-transform transform hover:scale-105 focus:outline-none">
                            çœ‹ç­”æ¡ˆ
                        </button>
                        <button id="next-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow transition-transform transform hover:scale-105 focus:outline-none">
                            ä¸‹ä¸€ä¸ª
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="tts-unsupported" class="text-center p-4 bg-red-100 text-red-700 rounded-lg hidden">
                æŠ±æ­‰ï¼Œä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»åŠŸèƒ½ã€‚
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. æ•°æ®å®šä¹‰ ---

            // ç”Ÿå­—åˆ—è¡¨ (32ä¸ª)
            const characters = [
                { char: "ä¸Š" }, { char: "ä¸‹" }, { char: "å£" }, { char: "ç›®" },
                { char: "ä¸­" }, { char: "å±±" }, { char: "å·¦" }, { char: "å³" },
                { char: "æ­Œ" }, { char: "å°" }, { char: "å¤§" }, { char: "æ‰‹" },
                { char: "äº”" }, { char: "ä¸" }, { char: "åª" }, { char: "å¥³" },
                { char: "åœ" }, { char: "å…¬" }, { char: "å·´" }, { char: "å¤´" },
                { char: "å­" }, { char: "ç”Ÿ" }, { char: "ç™½" }, { char: "ç«‹" },
                { char: "å››" }, { char: "å»" }, { char: "ä¹" }, { char: "é—¨" },
                { char: "å…±" }, { char: "èµ°" }, { char: "åŠ " }, { char: "æ¯”" }
            ];

            // ç¬”ç”»åˆ—è¡¨ (7ä¸ª)
            const strokes = [
                { name: "æ’‡", char: "ä¸¿" },
                { name: "æº", char: "ï¼¼" },
                { name: "ç«–å‹¾", char: "äº…" },
                { name: "ç«–æŠ˜å‹¾", char: "ä¹š" },
                { name: "æ¨ªæŠ˜å‹¾", char: "ğ ƒŒ" },
                { name: "æ¨ªæŠ˜å¼¯å‹¾", char: "ä¹™" },
                { name: "ç«–æ", char: "ğ „Œ" }
            ];

            // --- 2. çŠ¶æ€å˜é‡ ---
            let currentList = [];
            let currentIndex = 0;
            let currentWord = null;
            let activeMode = 'chars'; // 'chars' æˆ– 'strokes'
            let isDrawing = false;
            let isAnswerVisible = false;
            let chineseVoice = null; // [æ–°å¢] ç”¨äºå­˜å‚¨ä¸­æ–‡è¯­éŸ³

            // --- 3. DOM å…ƒç´  ---
            const canvas = document.getElementById('draw-canvas');
            const ctx = canvas.getContext('2d');
            const playBtn = document.getElementById('play-btn'); // [FIX] è¿™ä¸ªæŒ‰é’®ç°åœ¨å­˜åœ¨äºHTMLä¸­
            const clearBtn = document.getElementById('clear-btn');
            const showAnswerBtn = document.getElementById('show-answer-btn');
            const nextBtn = document.getElementById('next-btn');
            const tabChars = document.getElementById('tab-chars');
            const tabStrokes = document.getElementById('tab-strokes');
            const progressEl = document.getElementById('progress'); // [FIX] è¿™ä¸ªå…ƒç´ ç°åœ¨å­˜åœ¨äºHTMLä¸­
            const answerDisplayEl = document.getElementById('answer-display');
            const answerTextEl = document.getElementById('answer-text');
            const completeDisplayEl = document.getElementById('complete-display');
            const restartBtn = document.getElementById('restart-btn');
            const dictationArea = document.getElementById('dictation-area');
            const ttsUnsupported = document.getElementById('tts-unsupported');

            // [æ–°å¢] å¼€å§‹å±å¹•å’Œç»ƒä¹ å®¹å™¨
            const startScreen = document.getElementById('start-screen');
            const startBtn = document.getElementById('start-btn');
            const practiceContainer = document.getElementById('practice-container');

            // --- 4. è¯­éŸ³åˆæˆ ---
            let synth;
            if ('speechSynthesis' in window) {
                synth = window.speechSynthesis;
            } else {
                // ä¸æ”¯æŒè¯­éŸ³
                dictationArea.classList.add('hidden');
                ttsUnsupported.classList.remove('hidden');
                return; // ç»“æŸåˆå§‹åŒ–
            }

            // [æ–°å¢] å°è¯•åŠ è½½ä¸­æ–‡è¯­éŸ³
            function loadVoices() {
                // å°è¯•æ‰¾åˆ° 'zh-CN' è¯­éŸ³
                const voices = synth.getVoices();
                chineseVoice = voices.find(voice => voice.lang === 'zh-CN');
                
                // å¦‚æœæ‰¾ä¸åˆ° 'zh-CN'ï¼Œå°è¯•æ‰¾ä»»ä½•ä¸­æ–‡è¯­éŸ³
                if (!chineseVoice) {
                    chineseVoice = voices.find(voice => voice.lang.startsWith('zh'));
                }
            }

            // --- 5. æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

            // Fisher-Yates æ´—ç‰Œç®—æ³•
            function shuffle(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex !== 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [
                        array[randomIndex], array[currentIndex]];
                }
                return array;
            }

            // åˆ‡æ¢æ¨¡å¼ (ç”Ÿå­— / ç¬”ç”»)
            function setMode(mode) {
                activeMode = mode;
                if (mode === 'chars') {
                    currentList = shuffle([...characters]);
                    tabChars.classList.add('tab-active');
                    tabStrokes.classList.remove('tab-active');
                } else {
                    currentList = shuffle([...strokes]);
                    tabStrokes.classList.add('tab-active');
                    tabChars.classList.remove('tab-active');
                }
                currentIndex = 0;
                loadWord();
            }

            // åŠ è½½å•è¯/ç¬”ç”»
            function loadWord() {
                // éšè—ç»“æŸç”»é¢
                completeDisplayEl.classList.add('hidden');
                dictationArea.classList.remove('hidden');
                
                if (currentIndex >= currentList.length) {
                    showCompletion();
                    return;
                }

                currentWord = currentList[currentIndex];
                
                // æ›´æ–°è¿›åº¦
                progressEl.textContent = `ç¬¬ ${currentIndex + 1} / ${currentList.length} ä¸ª`;
                
                // å‡†å¤‡ç­”æ¡ˆ
                if (activeMode === 'chars') {
                    answerTextEl.textContent = currentWord.char;
                } else {
                    answerTextEl.textContent = `${currentWord.name} (${currentWord.char})`;
                }
                
                // é‡ç½®çŠ¶æ€
                clearCanvas();
                hideAnswer();
                
                // [ä¿®æ”¹] ç§»é™¤è‡ªåŠ¨æ’­æ”¾ï¼Œæ”¹ä¸ºç”¨åŠ¨ç”»æç¤ºç”¨æˆ·ç‚¹å‡»æ’­æ”¾
                playBtn.classList.add('animate-pulse'); // æç¤ºç”¨æˆ·ç‚¹å‡»
            }

            // æ˜¾ç¤ºç»ƒä¹ å®Œæˆ
            function showCompletion() {
                dictationArea.classList.add('hidden');
                completeDisplayEl.classList.remove('hidden');
                synth.cancel(); // åœæ­¢æ‰€æœ‰è¯­éŸ³
            }

            // æœ—è¯»
            // [ADJUSTMENT] è¿™æ˜¯ä½ è¦æ±‚çš„ä¸»è¦æ›´æ”¹
            function speak() {
                if (!currentWord) return;
                playBtn.classList.remove('animate-pulse'); // [æ–°å¢] ä¸€æ—¦ç‚¹å‡»ï¼Œå°±ç§»é™¤åŠ¨ç”»
                synth.cancel(); // åœæ­¢ä¸Šä¸€ä¸ª
                
                // 1. [æ–°å¢] æœ—è¯»æç¤ºè¯­ "è¯·å¬å†™"
                const introText = "è¯·å¬å†™";
                const introUtterance = new SpeechSynthesisUtterance(introText);
                if (chineseVoice) {
                    introUtterance.voice = chineseVoice;
                } else {
                    // ç¡®ä¿è¯­éŸ³è¢«è®¾ç½®
                    loadVoices();
                    if(chineseVoice) introUtterance.voice = chineseVoice;
                    else introUtterance.lang = 'zh-CN';
                }
                introUtterance.rate = 1.0; // æç¤ºè¯­ç”¨æ­£å¸¸è¯­é€Ÿ
                synth.speak(introUtterance);


                // 2. [ä¿®æ”¹] æœ—è¯»å½“å‰çš„å­—è¯
                const textToSpeak = (activeMode === 'chars') ? currentWord.char : currentWord.name;
                const utterance = new SpeechSynthesisUtterance(textToSpeak);

                // [ä¿®æ”¹] å…³é”®ä¿®å¤ï¼šæ˜¾å¼è®¾ç½®è¯­éŸ³
                if (chineseVoice) {
                    utterance.voice = chineseVoice;
                } else {
                    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ
                    utterance.lang = 'zh-CN';
                }
                
                utterance.rate = 0.8; // ç¨æ…¢çš„è¯­é€Ÿ
                
                // [å…³é”®] æµè§ˆå™¨ä¼šè‡ªåŠ¨å°†è¿™ä¸ªè¯­éŸ³æ’åœ¨ "è¯·å¬å†™" ä¹‹åæ’­æ”¾
                synth.speak(utterance);
            }

            // æ˜¾ç¤º/éšè—ç­”æ¡ˆ
            function toggleAnswer() {
                isAnswerVisible = !isAnswerVisible;
                if (isAnswerVisible) {
                    answerDisplayEl.classList.remove('hidden');
                    showAnswerBtn.textContent = 'éšè—ç­”æ¡ˆ';
                    showAnswerBtn.classList.remove('bg-yellow-400', 'hover:bg-yellow-500');
                    showAnswerBtn.classList.add('bg-gray-400', 'hover:bg-gray-500');
                } else {
                    hideAnswer();
                }
            }
            
            function hideAnswer() {
                isAnswerVisible = false;
                answerDisplayEl.classList.add('hidden');
                showAnswerBtn.textContent = 'çœ‹ç­”æ¡ˆ';
                showAnswerBtn.classList.add('bg-yellow-400', 'hover:bg-yellow-500');
                showAnswerBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500');
            }

            // ä¸‹ä¸€ä¸ª
            function nextWord() {
                currentIndex++;
                loadWord();
            }

            // --- 6. ç”»æ¿åŠŸèƒ½ ---
            function resizeCanvas() {
                // è®¾ç½®canvasçš„CSSå®½åº¦ä¸º100%ï¼Œç„¶åè·å–å…¶åƒç´ å®½åº¦
                canvas.style.width = '100%';
                const width = canvas.clientWidth;
                const height = width * 0.75; // ä¿æŒ 4:3 æ¯”ä¾‹
                
                // è®¾ç½®canvasçš„ç»˜å›¾è¡¨é¢å¤§å°
                canvas.width = width;
                canvas.height = height;

                // è®¾ç½®ç»˜å›¾æ ·å¼
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            }

            function getEventPosition(e) {
                const rect = canvas.getBoundingClientRect();
                let x, y;
                if (e.touches && e.touches.length > 0) {
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                } else {
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                return { x, y };
            }

            function startDrawing(e) {
                isDrawing = true;
                const { x, y } = getEventPosition(e);
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
                const { x, y } = getEventPosition(e);
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            function stopDrawing() {
                if (isDrawing) {
                    ctx.closePath();
                    isDrawing = false;
                }
            }

            function clearCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            // --- 7. äº‹ä»¶ç›‘å¬ ---
            
            // [æ–°å¢] å¼€å§‹æŒ‰é’®ç›‘å¬
            startBtn.addEventListener('click', () => {
                // 1. å†æ¬¡å°è¯•åŠ è½½è¯­éŸ³ï¼Œå› ä¸ºç”¨æˆ·å·²äº¤äº’
                loadVoices();

                // 2. [å…³é”®] æ’­æ”¾ä¸€ä¸ªç®€çŸ­çš„â€œå”¤é†’â€è¯­éŸ³æ¥å¯åŠ¨è¯­éŸ³å¼•æ“
                synth.cancel(); // æ¸…é™¤é˜Ÿåˆ—
                const welcomeUtterance = new SpeechSynthesisUtterance('ä½ å¥½');
                
                if (chineseVoice) {
                    welcomeUtterance.voice = chineseVoice;
                } else {
                    welcomeUtterance.lang = 'zh-CN';
                }
                welcomeUtterance.rate = 0.1; // æ’­æ”¾å¾—å¾ˆå¿«
                synth.speak(welcomeUtterance);
                
                // 3. éšè—å¼€å§‹å±å¹•, æ˜¾ç¤ºç»ƒä¹ ç•Œé¢
                startScreen.classList.add('hidden');
                practiceContainer.classList.remove('hidden');

                // 4. åŠ è½½ç¬¬ä¸€ä¸ªè¯
                setMode('chars'); // é»˜è®¤åŠ è½½ç”Ÿå­—
            });

            // æ¨¡å¼åˆ‡æ¢
            tabChars.addEventListener('click', () => setMode('chars'));
            tabStrokes.addEventListener('click', () => setMode('strokes'));
            
            // æ§åˆ¶æŒ‰é’®
            playBtn.addEventListener('click', speak);
            clearBtn.addEventListener('click', clearCanvas);
            showAnswerBtn.addEventListener('click', toggleAnswer);
            nextBtn.addEventListener('click', nextWord);
            restartBtn.addEventListener('click', () => setMode(activeMode));
            
            // ç”»æ¿äº‹ä»¶ (æ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸)
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing); // ç§»å‡ºç”»å¸ƒä¹Ÿåœæ­¢

            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', resizeCanvas);

            // --- 8. åˆå§‹åŒ– ---
            resizeCanvas();
            
            // [ä¿®æ”¹] ç«‹å³åŠ è½½è¯­éŸ³ï¼Œå¹¶ç›‘å¬å˜åŒ–
            loadVoices();
            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = loadVoices;
            }
        });
    </script>
</body>
</html>
